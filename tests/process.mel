#!/usr/bin/env melodium
#! name = process_test
#! version = 0.7.1
#! require = std:0.7.1
#! require = fs:0.7.1
#! require = process:0.7.1

use std/engine/util::startup
use std/flow::stream
use std/text/convert/string::toUtf8
use std/flow::emit
use std/data::|map
use fs/file::write
use process::Environment
use process::spawn

treatment main()
  model env: Environment(
        env=|map([]),
        working_dir=_
    )
{

    spawn[env=env](command="sed")
    emitArgs: emit<Vec<string>>(value=["-e", "s/foo/bar/g"])
    startup()
    
    startup.trigger -> emitArgs.trigger,emit -> spawn.args
    startup.trigger --------------------------> spawn.launch

    emitText: emit<string>(value="This is foo!")
    streamText: stream<string>()
    toUtf8()
    emitFilename: emit<string>(value="./replaced.txt")
    file: write()
    startup.trigger -> emitText.trigger,emit -> streamText.block,stream -> toUtf8.text,encoded -> spawn.stdin,stdout -> file.data
    startup.trigger ---------------------------------------------------------------------> emitFilename.trigger,emit -> file.path    
}
