
release:gitlab:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: ( $CI_COMMIT_TAG )
  needs:
    - job: package:zips
      artifacts: true
  script:
    - echo "Making GitLab release Mélodium version $VERSION from tag $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Mélodium $VERSION"
    description: 'melodium/CHANGELOG.md'
    assets:
      links:
        - name: Windows ARM 64 bits (arm64, MSVC compiler)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_aarch64-pc-windows-msvc.zip"
          link_type: package
        - name: Windows 32 bits (i686, MSVC compiler)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_i686-pc-windows-msvc.zip"
          link_type: package
        - name: Windows 32 bits (i686, GNU compiler)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_i686-pc-windows-gnu.zip"
          link_type: package
        - name: Windows 64 bits (x86_64, MSVC compiler)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_x86_64-pc-windows-msvc.zip"
          link_type: package
        - name: Windows 64 bits (x86_64, GNU compiler)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_x86_64-pc-windows-gnu.zip"
          link_type: package
        - name: MacOS ARM 64 bits (arm64)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_aarch64-apple-darwin.tar.gz"
          link_type: package
        - name: MacOS 32 bits (i686)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_i686-apple-darwin.tar.gz"
          link_type: package
        - name: MacOS 64 bits (x86_64)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_x86_64-apple-darwin.tar.gz"
          link_type: package
        - name: Linux ARM 64 bits (arm64, musl)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_aarch64-unknown-linux-musl.tar.gz"
          link_type: package
        - name: Linux ARM 64 bits (arm64, glibc)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_aarch64-unknown-linux-gnu.tar.gz"
          link_type: package
        - name: Linux 32 bits (i686, musl)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_i686-unknown-linux-musl.tar.gz"
          link_type: package
        - name: Linux 32 bits (i686, glibc)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_i686-unknown-linux-gnu.tar.gz"
          link_type: package
        - name: Linux 64 bits (x86_64, musl)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_x86_64-unknown-linux-musl.tar.gz"
          link_type: package
        - name: Linux 64 bits (x86_64, glibc)
          url: "https://repo.melodium.tech/zips/$VERSION/melodium-${VERSION}_x86_64-unknown-linux-gnu.tar.gz"
          link_type: package
        - name: crates.io
          url: "https://crates.io/crates/melodium/$VERSION"
          link_type: other
        - name: docs.rs
          url: "https://docs.rs/melodium/$VERSION/melodium/"
          link_type: other
        - name: Repository
          url: "https://repo.melodium.tech/zips/$VERSION/"
          link_type: other
        - name: Reference
          url: "https://doc.melodium.tech/$VERSION/"
          link_type: other

release:publish:zips:
  stage: release
  image: debian:bullseye
  rules:
    - if: ( $CI_COMMIT_TAG )
  variables:
    GIT_STRATEGY: none
  needs:
    - job: package:zips
      artifacts: true
  before_script:
    - apt-get update
    - apt-get install -y rsync sshpass
  script:
    - mkdir ~/.ssh
    - ssh-keyscan "$ZIP_RELEASE_PUBLISH_SERVER" >> ~/.ssh/known_hosts
    - mkdir "$VERSION"
    - mv melodium-* SHA256SUMS "$VERSION/"
    - SSHPASS="$ZIP_RELEASE_PUBLISH_PASSWORD" sshpass -e rsync -a "$VERSION" "$ZIP_RELEASE_PUBLISH_USER@$ZIP_RELEASE_PUBLISH_SERVER:$ZIP_RELEASE_PUBLISH_DIRECTORY"

